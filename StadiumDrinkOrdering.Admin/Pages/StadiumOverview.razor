@page "/admin/stadium-overview"

<PageTitle>Stadium Overview - Admin</PageTitle>

<div class="container-fluid stadium-overview-container" id="stadium-overview-container">
    <h3 class="mb-4" id="stadium-overview-title">üèüÔ∏è Stadium Overview</h3>

    <!-- Stadium Information and Map Layout -->
    <div class="stadium-layout-container @(isInfoPanelCollapsed ? "info-panel-collapsed" : "info-panel-expanded")" id="stadium-layout-container">
        <!-- Stadium Information Panel -->
        <StadiumInfoPanel 
            StadiumData="stadiumData" 
            SelectedEvent="GetSelectedEvent()" 
            EventSeatStatus="eventSeatStatus" 
            IsCollapsed="isInfoPanelCollapsed" 
            OnTogglePanel="HandleInfoPanelToggle"
            OnTribuneSelected="OnTribuneSelected"
            OnTribuneHovered="OnTribuneHovered" />

        <!-- Stadium Map Section -->
        <div class="stadium-viewer-container" id="stadium-viewer-container">
            <div class="viewer-header" id="stadium-viewer-header">
            <div class="viewer-controls" id="stadium-viewer-controls">
                <div class="event-selector" id="event-selector-container">
                    <label for="eventSelect" id="event-select-label">Select Event:</label>
                    <select id="eventSelect" class="form-select" @bind="selectedEventId" @bind:after="OnEventChanged">
                        <option value="0">-- No Event Selected --</option>
                        @if (events != null)
                        {
                            @foreach (var evt in events)
                            {
                                <option value="@evt.Id">@evt.EventName - @evt.EventDate.ToString("MMM dd, yyyy")</option>
                            }
                        }
                    </select>
                </div>

                <div class="search-seat" id="seat-search-container">
                    <input type="text" class="form-control" placeholder="Search seat (e.g., N1A-R5S12)" 
                           @bind="searchSeatCode" @onkeyup="@(async (e) => { if (e.Key == "Enter") await SearchSeat(); })" 
                           id="seat-search-input" />
                    <button class="btn btn-sm btn-primary" @onclick="SearchSeat" id="seat-search-button">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>

                <div class="view-options" id="view-options-container">
                    <button class="btn btn-sm @(showLegend ? "btn-primary" : "btn-outline-primary")" 
                            @onclick="() => showLegend = !showLegend" 
                            id="toggle-legend-button">
                        <i class="bi bi-info-circle"></i> Legend
                    </button>
                    <button class="btn btn-sm @(showOccupancy ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => showOccupancy = !showOccupancy" 
                            id="toggle-occupancy-button">
                        <i class="bi bi-pie-chart"></i> Occupancy
                    </button>
                    @if (selectedEventId > 0)
                    {
                        <button class="btn btn-sm btn-warning" @onclick="SimulateTicketSales" disabled="@isSimulating" id="admin-stadium-simulate-btn">
                            @if (isSimulating)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Simulate Sales
                        </button>
                    }
                </div>
            </div>
        </div>

        @* Dynamic Stadium SVG - Generated using exact HNK Rijeka coordinates *@
        @if (stadiumLayout != null)
        {
            <!-- Dynamic HNK Rijeka Stadium - Looks identical to static version -->
            <div class="stadium-main-view" id="stadium-main-view">
                <div class="svg-container" @ref="svgContainer" id="stadium-svg-container">
                    <StadiumDrinkOrdering.Admin.Components.Stadium.StadiumSvgRenderer 
                        Layout="@stadiumLayout" 
                        EventSeatStatus="@svgEventSeatStatus" 
                        ShowSeatCount="@showOccupancy"
                        OnSectorClick="@OnSectorClicked" />
                </div>

                @if (showLegend)
                {
                    <div class="legend-panel" id="legend-panel">
                        <h5 id="legend-title">@(stadiumLayout?.Name ?? "HNK Rijeka Stadium")</h5>
                        @if (selectedEventId > 0)
                        {
                            <!-- Event-based occupancy legend -->
                            <div class="legend-item" id="legend-available">
                                <span class="legend-color" style="background: #16a34a;" id="legend-green-color"></span>
                                <span id="legend-green-text">Available (0-49%)</span>
                            </div>
                            <div class="legend-item" id="legend-partial">
                                <span class="legend-color" style="background: #ca8a04;" id="legend-orange-color"></span>
                                <span id="legend-orange-text">Partial (50-89%)</span>
                            </div>
                            <div class="legend-item" id="legend-full">
                                <span class="legend-color" style="background: #dc2626;" id="legend-red-color"></span>
                                <span id="legend-red-text">Full (90-100%)</span>
                            </div>
                        }
                        else
                        {
                            <!-- Default stadium colors -->
                            <div class="legend-item" id="legend-standard">
                                <span class="legend-color" style="background: #4A90E2;" id="legend-blue-color"></span>
                                <span id="legend-blue-text">Standard Sectors</span>
                            </div>
                            <div class="legend-item" id="legend-premium">
                                <span class="legend-color" style="background: #F39C12;" id="legend-orange-color"></span>
                                <span id="legend-orange-text">Premium Sectors</span>
                            </div>
                            <div class="legend-item" id="legend-unavailable">
                                <span class="legend-color" style="background: #9E9E9E;" id="legend-gray-color"></span>
                                <span id="legend-gray-text">Unavailable</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Loading state or error message -->
            <div class="stadium-main-view" id="stadium-main-view">
                <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                    @if (isLoading)
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading dynamic stadium layout...</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-warning text-center">
                            <h5><i class="bi bi-exclamation-triangle"></i> Stadium Layout Error</h5>
                            <p>@errorMessage</p>
                            <button class="btn btn-primary" @onclick="LoadStadiumLayout">
                                <i class="bi bi-arrow-clockwise"></i> Retry
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <h5><i class="bi bi-info-circle"></i> No Stadium Data</h5>
                            <p>Stadium layout not available. Please check the stadium structure configuration.</p>
                        </div>
                    }
                </div>
            </div>
        }
        </div>
    </div>
</div>

<!-- Sector Detail Modal -->
@if (showSectorModal && selectedSector != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);" id="sector-detail-modal">
        <div class="modal-dialog modal-xl" id="sector-modal-dialog">
            <div class="modal-content" id="sector-modal-content">
                <div class="modal-header" id="sector-modal-header">
                    <h5 class="modal-title" id="sector-modal-title">@selectedSector.Name - Admin View</h5>
                    <button type="button" class="btn-close" @onclick="CloseSectorModal" id="sector-modal-close-button"></button>
                </div>
                <div class="modal-body" id="sector-modal-body">
                    <div class="seat-canvas-container" id="seat-canvas-container">
                        <canvas @ref="seatCanvas" width="1200" height="600" id="seat-canvas"></canvas>
                    </div>
                    <div class="seat-info-panel" id="seat-info-panel">
                        @if (selectedSeats.Any())
                        {
                            <h6 id="selected-seats-title">Selected Seats:</h6>
                            <ul id="selected-seats-list">
                                @foreach (var seat in selectedSeats)
                                {
                                    <li id="selected-seat-@seat.Replace(" ", "-")">@seat</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted" id="no-selected-seats-message">Click on seats to view details</p>
                        }
                    </div>
                </div>
                <div class="modal-footer" id="sector-modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSectorModal" id="sector-modal-close-footer-button">Close</button>
                </div>
            </div>
        </div>
    </div>
}

