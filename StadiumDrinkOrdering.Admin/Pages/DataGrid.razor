@page "/datagrid"

<PageTitle>Database Explorer</PageTitle>

<div class="database-explorer">
    <div class="header-section">
        <h3><i class="oi oi-grid-three-up me-2"></i>Database Explorer</h3>
        <p class="text-muted">Browse and manage database tables with advanced filtering, sorting, and export capabilities</p>
    </div>

    <div class="container-fluid">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Connecting to database...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger d-flex align-items-center" role="alert">
                <i class="oi oi-warning me-2"></i>
                <div>
                    <strong>Connection Error:</strong> @errorMessage
                    <button class="btn btn-sm btn-outline-danger ms-3" @onclick="RetryConnection" id="admin-datagrid-retry-btn">
                        <i class="oi oi-reload"></i> Retry
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="table-selector-card">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="oi oi-list me-1"></i> Select Table:
                        </label>
                        <select class="form-select form-select-lg" @onchange="OnTableChanged" value="@selectedTable">
                            <option value="">-- Choose a table to explore --</option>
                            @foreach (var table in tables)
                            {
                                <option value="@table.EntityName">
                                    @table.Name 
                                    <span class="text-muted">(@table.ColumnCount columns)</span>
                                </option>
                            }
                        </select>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedTable))
                    {
                        <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" @onclick="RefreshData" title="Refresh Data" id="admin-datagrid-refresh-btn">
                                    <i class="oi oi-reload"></i> Refresh
                                </button>
                                <button class="btn btn-success" @onclick="ExportToCsv" title="Export to CSV" id="admin-datagrid-export-btn">
                                    <i class="oi oi-data-transfer-download"></i> Export CSV
                                </button>
                                <button class="btn btn-info" @onclick="ShowTableInfo" title="Table Information" id="admin-datagrid-table-info-btn">
                                    <i class="oi oi-info"></i> Info
                                </button>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-warning" @onclick="ShowGenerateModal" title="Generate Data" id="admin-datagrid-generate-btn">
                                        <i class="oi oi-plus"></i> Generate
                                    </button>
                                    <button class="btn btn-danger" @onclick="ShowDeleteModal" title="Delete All Data" id="admin-datagrid-delete-btn">
                                        <i class="oi oi-trash"></i> Clear Table
                                    </button>
                                </div>
                            </div>
                            <div class="record-count">
                                <span class="badge bg-primary">@totalCount Records</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(selectedTable) && tableData != null)
            {
                @if (showTableInfo)
                {
                    <div class="table-info-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="oi oi-spreadsheet me-2"></i>Table Structure</h5>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => showTableInfo = false" id="admin-datagrid-close-table-info-btn">
                                <i class="oi oi-x"></i>
                            </button>
                        </div>
                        <div class="row">
                            @foreach (var column in columns)
                            {
                                <div class="col-md-4 mb-2">
                                    <div class="column-info">
                                        <strong>@column.Name</strong>
                                        <span class="badge bg-secondary ms-2">@column.Type</span>
                                        @if (column.IsPrimaryKey)
                                        {
                                            <span class="badge bg-warning ms-1">PK</span>
                                        }
                                        @if (column.IsForeignKey)
                                        {
                                            <span class="badge bg-info ms-1">FK</span>
                                        }
                                        @if (column.IsNullable)
                                        {
                                            <span class="text-muted ms-1">(nullable)</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="datagrid-container">
                    <div class="filter-toolbar">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="text-muted">
                                    <i class="oi oi-filter"></i> 
                                    @if (filters.Any())
                                    {
                                        <span>@filters.Count filter(s) applied</span>
                                        <button class="btn btn-sm btn-outline-warning ms-2" @onclick="ClearFilters" id="admin-datagrid-clear-filters-btn">
                                            Clear All
                                        </button>
                                    }
                                    else
                                    {
                                        <span>No filters applied</span>
                                    }
                                </span>
                            </div>
                            <div class="search-box">
                                <input type="text" class="form-control form-control-sm" 
                                       placeholder="Quick search..." 
                                       @oninput="OnQuickSearchChanged" />
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover datagrid-table">
                            <thead class="table-light sticky-header">
                                <tr>
                                    @foreach (var column in columns)
                                    {
                                        <th class="datagrid-header">
                                            <div class="column-header">
                                                <div class="column-title" @onclick="() => Sort(column.Name)">
                                                    <span>@column.Name</span>
                                                    @if (sortColumn == column.Name)
                                                    {
                                                        @if (sortDirection == "asc")
                                                        {
                                                            <i class="oi oi-arrow-top text-primary"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="oi oi-arrow-bottom text-primary"></i>
                                                        }
                                                    }
                                                </div>
                                                <input type="text" 
                                                       class="form-control form-control-sm filter-input" 
                                                       placeholder="Filter..."
                                                       value="@GetFilterValue(column.Name)"
                                                       @oninput="(e) => OnFilterChanged(column.Name, e.Value?.ToString())"
                                                       @onkeyup="@(async (e) => { if (e.Key == "Enter") await ApplyFilters(); })" />
                                            </div>
                                        </th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @if (isLoadingData)
                                {
                                    <tr>
                                        <td colspan="@columns.Count" class="text-center p-4">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading data...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Fetching records...</p>
                                        </td>
                                    </tr>
                                }
                                else if (tableData.Count == 0)
                                {
                                    <tr>
                                        <td colspan="@columns.Count" class="text-center p-4">
                                            <div class="no-data">
                                                <i class="oi oi-inbox text-muted" style="font-size: 2rem;"></i>
                                                <p class="mt-2 text-muted">No records found</p>
                                                @if (filters.Any())
                                                {
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="ClearFilters" id="admin-datagrid-clear-filters-empty-btn">
                                                        Clear Filters
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var row in tableData)
                                    {
                                        <tr class="data-row">
                                            @foreach (var column in columns)
                                            {
                                                <td class="datagrid-cell">
                                                    @{
                                                        var value = row.ContainsKey(column.Name) ? row[column.Name] : null;
                                                        if (value == null)
                                                        {
                                                            <span class="null-value">null</span>
                                                        }
                                                        else if (value is bool boolValue)
                                                        {
                                                            if (boolValue)
                                                            {
                                                                <span class="badge bg-success">
                                                                    <i class="oi oi-check"></i> True
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">
                                                                    <i class="oi oi-x"></i> False
                                                                </span>
                                                            }
                                                        }
                                                        else if (value is DateTime dateValue)
                                                        {
                                                            <span class="date-value" title="@dateValue.ToString("F")">
                                                                <i class="oi oi-calendar"></i> @dateValue.ToString("yyyy-MM-dd HH:mm")
                                                            </span>
                                                        }
                                                        else if (decimal.TryParse(value.ToString(), out var decimalValue) && column.Name.Contains("Price", StringComparison.OrdinalIgnoreCase))
                                                        {
                                                            <span class="price-value">$@decimalValue.ToString("F2")</span>
                                                        }
                                                        else
                                                        {
                                                            <span title="@value.ToString()">@value.ToString()</span>
                                                        }
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (totalPages > 1)
                    {
                        <div class="pagination-container">
                            <div class="page-size-selector">
                                <label class="me-2">Rows per page:</label>
                                <select class="form-select form-select-sm" style="width: auto;" @onchange="OnPageSizeChanged" value="@pageSize">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            
                            <nav aria-label="Page navigation">
                                <ul class="pagination mb-0">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(currentPage == 1)" id="admin-datagrid-first-page-btn">
                                            <i class="oi oi-media-skip-backward"></i> First
                                        </button>
                                    </li>
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)" id="admin-datagrid-prev-page-btn">
                                            <i class="oi oi-chevron-left"></i>
                                        </button>
                                    </li>
                                    
                                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                    {
                                        var pageNum = i;
                                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(pageNum)" id="admin-datagrid-page-@pageNum-btn">
                                                @pageNum
                                            </button>
                                        </li>
                                    }
                                    
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)" id="admin-datagrid-next-page-btn">
                                            <i class="oi oi-chevron-right"></i>
                                        </button>
                                    </li>
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => GoToPage(totalPages)" disabled="@(currentPage == totalPages)" id="admin-datagrid-last-page-btn">
                                            Last <i class="oi oi-media-skip-forward"></i>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                            
                            <div class="page-info">
                                <strong>Page @currentPage of @totalPages</strong>
                                <span class="text-muted ms-2">(@totalCount total records)</span>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

<!-- Generate Data Modal -->
@if (showGenerateModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="oi oi-plus text-warning"></i>
                        Generate Data for @selectedTable
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideGenerateModal" aria-label="Close" id="admin-datagrid-generate-modal-close-btn"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(generateValidationMessage))
                    {
                        <div class="alert alert-warning" role="alert">
                            <i class="oi oi-warning"></i>
                            @generateValidationMessage
                            @if (generateDependencies.Any())
                            {
                                <ul class="mb-0 mt-2">
                                    @foreach (var dep in generateDependencies)
                                    {
                                        <li>@dep</li>
                                    }
                                </ul>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="form-group mb-3">
                            <label for="recordCount" class="form-label">Number of records to generate:</label>
                            <input type="number" class="form-control" id="recordCount" @bind="recordCount" 
                                   min="1" max="1000" placeholder="Enter count (1-1000)"/>
                            <div class="form-text">
                                Generate up to 1000 sample records with realistic data for testing purposes.
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="oi oi-info"></i>
                            <strong>About Generated Data:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Data will be created with realistic sample values</li>
                                <li>All required relationships will be properly linked</li>
                                <li>Generated data is safe for testing and development</li>
                            </ul>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideGenerateModal" id="admin-datagrid-generate-modal-cancel-btn">Cancel</button>
                    @if (string.IsNullOrEmpty(generateValidationMessage))
                    {
                        <button type="button" class="btn btn-warning" @onclick="GenerateData" disabled="@isGenerating" id="admin-datagrid-generate-modal-submit-btn">
                            @if (isGenerating)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Generating...</span>
                            }
                            else
                            {
                                <i class="oi oi-plus"></i>
                                <span>Generate @recordCount Records</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal fade show" tabindex="-1" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="oi oi-warning text-danger"></i>
                        Clear Table @selectedTable
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideDeleteModal" aria-label="Close" id="admin-datagrid-delete-modal-close-btn"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(deleteValidationMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="oi oi-warning"></i>
                            <strong>Cannot Delete:</strong>
                            <p>@deleteValidationMessage</p>
                            @if (deleteDependencies.Any())
                            {
                                <p><strong>Dependencies found:</strong></p>
                                <ul class="mb-0">
                                    @foreach (var dep in deleteDependencies)
                                    {
                                        <li>@dep</li>
                                    }
                                </ul>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <i class="oi oi-warning"></i>
                            <strong>Warning: This action cannot be undone!</strong>
                        </div>
                        <p>You are about to delete <strong>ALL @totalCount records</strong> from the <strong>@selectedTable</strong> table.</p>
                        <p>Type <strong>DELETE</strong> to confirm this action:</p>
                        <input type="text" class="form-control" @bind="deleteConfirmation" placeholder="Type DELETE to confirm" />
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideDeleteModal" id="admin-datagrid-delete-modal-cancel-btn">Cancel</button>
                    @if (string.IsNullOrEmpty(deleteValidationMessage))
                    {
                        <button type="button" class="btn btn-danger" @onclick="DeleteAllData"
                                disabled="@(deleteConfirmation != "DELETE" || isDeleting)" id="admin-datagrid-delete-modal-confirm-btn">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Deleting...</span>
                            }
                            else
                            {
                                <i class="oi oi-trash"></i>
                                <span>Delete All Records</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Success/Error Toast -->
@if (!string.IsNullOrEmpty(toastMessage))
{
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="oi @toastIcon me-2"></i>
                <strong class="me-auto">@toastTitle</strong>
                <button type="button" class="btn-close" @onclick="HideToast" aria-label="Close" id="admin-datagrid-toast-close-btn"></button>
            </div>
            <div class="toast-body">
                @toastMessage
            </div>
        </div>
    </div>
}