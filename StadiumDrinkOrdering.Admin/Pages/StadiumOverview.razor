@page "/admin/stadium-overview"
@using StadiumDrinkOrdering.Shared.Models
@using StadiumDrinkOrdering.Shared.DTOs
@using System.Globalization

<PageTitle>Stadium Operations Center - Admin</PageTitle>

<!-- Skip to Content Link for Accessibility -->
<a href="#stadium-main-content" class="skip-to-content sr-only-focusable">Skip to stadium content</a>

<!-- Live Region for Dynamic Updates -->
<div aria-live="polite" aria-atomic="true" class="live-region" id="stadium-status-updates"></div>

<div class="stadium-overview-wrapper" role="main" aria-labelledby="stadium-overview-title">
    <!-- Enhanced Header with Real-time Status -->
    <header class="stadium-overview-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="bi bi-building" aria-hidden="true"></i>
            </div>
            <div class="header-info">
                <h1 id="stadium-overview-title" class="overview-title">Stadium Operations Center</h1>
                <p class="overview-subtitle">Real-time stadium management dashboard</p>
            </div>
            <div class="header-status">
                <div class="status-indicator @(isLoading ? "loading" : "online")">
                    <div class="status-dot" aria-hidden="true"></div>
                    <span class="status-text">@(isLoading ? "Loading..." : "System Online")</span>
                </div>
                @if (lastUpdateTime.HasValue)
                {
                    <div class="last-update">
                        <small>Updated: @lastUpdateTime.Value.ToString("HH:mm:ss")</small>
                    </div>
                }
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main id="stadium-main-content" class="stadium-main-content">
        <!-- Control Panel -->
        <section class="control-panel" aria-labelledby="control-panel-title">
            <div class="control-panel-header">
                <h2 id="control-panel-title" class="panel-title">
                    <i class="bi bi-sliders" aria-hidden="true"></i>
                    Control Panel
                </h2>
                <p class="panel-subtitle">Manage events and view settings</p>
            </div>

            <div class="control-groups">
                <!-- Event Selection -->
                <div class="control-group" id="event-selector-group">
                    <label for="event-select" class="control-label">
                        <i class="bi bi-calendar-event" aria-hidden="true"></i>
                        Active Event
                    </label>
                    <select id="event-select"
                            class="form-select"
                            @bind="selectedEventId"
                            @bind:after="OnEventChanged"
                            aria-describedby="event-help">
                        <option value="0">-- No Event Selected --</option>
                        @if (events != null)
                        {
                            @foreach (var evt in events)
                            {
                                <option value="@evt.Id">
                                    @(!string.IsNullOrWhiteSpace(evt.EventName) ? evt.EventName : $"Event {evt.Id}") -
                                    @evt.EventDate.ToString("MMM dd, yyyy", CultureInfo.InvariantCulture)
                                </option>
                            }
                        }
                    </select>
                    <small id="event-help" class="form-text text-muted">
                        Select an event to view occupancy data
                    </small>
                </div>

                <!-- Seat Search -->
                <div class="control-group" id="seat-search-group">
                    <label for="seat-search-input" class="control-label">
                        <i class="bi bi-search" aria-hidden="true"></i>
                        Seat Locator
                    </label>
                    <div class="input-group">
                        <input type="text"
                               id="seat-search-input"
                               class="form-control"
                               placeholder="Enter seat code (e.g., N1A-R5S12)"
                               @bind="searchSeatCode"
                               @onkeyup="@(async (e) => { if (e.Key == "Enter") await SearchSeat(); })"
                               aria-describedby="search-help" />
                        <button class="btn btn-outline-primary"
                                @onclick="SearchSeat"
                                type="button"
                                aria-label="Search for seat">
                            <i class="bi bi-search" aria-hidden="true"></i>
                        </button>
                    </div>
                    <small id="search-help" class="form-text text-muted">
                        Find specific seats using stadium naming convention
                    </small>
                </div>

                <!-- Display Options -->
                <div class="control-group" id="display-options-group">
                    <span class="control-label">
                        <i class="bi bi-eye" aria-hidden="true"></i>
                        Display Options
                    </span>
                    <div class="btn-group" role="group" aria-label="Display options">
                        <button type="button"
                                class="btn btn-outline-secondary @(showLegend ? "active" : "")"
                                @onclick="ToggleLegend"
                                aria-pressed="@showLegend.ToString().ToLower()">
                            <i class="bi bi-info-circle" aria-hidden="true"></i>
                            Legend
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary @(showOccupancy ? "active" : "")"
                                @onclick="ToggleOccupancy"
                                aria-pressed="@showOccupancy.ToString().ToLower()">
                            <i class="bi bi-pie-chart" aria-hidden="true"></i>
                            Analytics
                        </button>
                        @if (selectedEventId > 0)
                        {
                            <button type="button"
                                    class="btn btn-primary @(isSimulating ? "loading" : "")"
                                    @onclick="SimulateTicketSales"
                                    disabled="@isSimulating">
                                @if (isSimulating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <i class="bi bi-lightning" aria-hidden="true"></i>
                                    <span>Simulate Sales</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            </div>
        </section>

        <!-- Stadium Visualization -->
        <section class="stadium-visualization" aria-labelledby="stadium-viz-title">
            <div class="visualization-header">
                <h2 id="stadium-viz-title" class="panel-title">
                    <i class="bi bi-diagram-3" aria-hidden="true"></i>
                    Stadium Layout
                </h2>
                @if (selectedEvent != null)
                {
                    <div class="event-info">
                        <span class="event-name">@selectedEvent.EventName</span>
                        <span class="event-date">@selectedEvent.EventDate.ToString("MMM dd, yyyy")</span>
                    </div>
                }
            </div>

            <div class="stadium-container" id="stadium-container">
                @if (isLoading)
                {
                    <div class="loading-state" role="status" aria-live="polite">
                        <div class="loading-content">
                            <div class="loading-spinner" aria-hidden="true"></div>
                            <h3>Loading Stadium Layout</h3>
                            <p>Preparing stadium visualization...</p>
                            <div class="loading-progress">
                                <div class="progress-bar" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-state" role="alert">
                        <div class="error-content">
                            <i class="bi bi-exclamation-triangle error-icon" aria-hidden="true"></i>
                            <h3>Stadium Layout Error</h3>
                            <p>@errorMessage</p>
                            <div class="error-actions">
                                <button class="btn btn-primary" @onclick="LoadStadiumLayout">
                                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                                    Retry Loading
                                </button>
                                <button class="btn btn-outline-primary" @onclick="GenerateDemoLayout">
                                    <i class="bi bi-plus-circle" aria-hidden="true"></i>
                                    Generate Demo Layout
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else if (stadiumData == null || !stadiumData.Stands.Any())
                {
                    <div class="empty-state" role="region" aria-labelledby="empty-state-title">
                        <div class="empty-content">
                            <i class="bi bi-database-x empty-icon" aria-hidden="true"></i>
                            <h3 id="empty-state-title">No Stadium Data</h3>
                            <p>No stadium layout is currently available.</p>
                            <div class="empty-actions">
                                <button class="btn btn-primary" @onclick="LoadStadiumLayout">
                                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                                    Load Stadium Data
                                </button>
                                <button class="btn btn-outline-primary" @onclick="GenerateDemoLayout">
                                    <i class="bi bi-plus-circle" aria-hidden="true"></i>
                                    Generate Demo Layout
                                </button>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Flexible Stadium Layout -->
                    <div class="stadium-flex-layout"
                         id="stadium-grid"
                         role="application"
                         aria-label="Interactive stadium seating map"
                         tabindex="0">

                        <!-- Stadium Field -->
                        <div class="stadium-field" aria-label="Playing field">
                            <div class="field-markings">
                                <div class="center-circle"></div>
                                <div class="center-line"></div>
                            </div>
                            <div class="field-label">FIELD</div>
                        </div>

                        <!-- Stadium Stands Container -->
                        @if (stadiumData.Stands != null)
                        {
                            <div class="stands-container">
                                @foreach (var stand in stadiumData.Stands)
                                {
                                    <div class="stadium-stand @GetStandPositionClass(stand)"
                                         data-stand="@stand.TribuneCode"
                                         role="region"
                                         aria-labelledby="stand-@stand.Id-title">

                                        <h3 id="stand-@stand.Id-title" class="stand-title">
                                            @stand.Name
                                        </h3>

                                        <div class="sectors-grid">
                                            @foreach (var sector in stand.Sectors)
                                            {
                                                <div class="sector @GetSectorCssClass(sector)"
                                                     role="button"
                                                     tabindex="0"
                                                     aria-label="@GetSectorAriaLabel(sector)"
                                                     data-sector="@sector.Id"
                                                     @onclick="() => OpenSectorModal(sector)"
                                                     @onkeydown="@(async (e) => { if (e.Key == "Enter" || e.Key == " ") await OpenSectorModal(sector); })">

                                                    <div class="sector-header">
                                                        <span class="sector-name">@sector.Name</span>
                                                        @if (IsVipSector(sector))
                                                        {
                                                            <span class="vip-badge" aria-label="VIP section">VIP</span>
                                                        }
                                                    </div>

                                                    <div class="sector-content">
                                                        <div class="seat-count">
                                                            <span class="available">@GetAvailableSeats(sector)</span>
                                                            <span class="separator">/</span>
                                                            <span class="total">@sector.TotalSeats</span>
                                                        </div>

                                                        @if (selectedEventId > 0 && showOccupancy)
                                                        {
                                                            <div class="occupancy-bar" aria-hidden="true">
                                                                <div class="occupancy-fill"
                                                                     style="width: @GetOccupancyPercentage(sector)%"></div>
                                                            </div>
                                                            <div class="occupancy-text">
                                                                @GetOccupancyPercentage(sector)% occupied
                                                            </div>
                                                        }
                                                    </div>

                                                    <div class="sector-status-indicator @GetSectorStatusClass(sector)"
                                                         aria-hidden="true"></div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </section>

        <!-- Stadium Information Panel -->
        @if (stadiumSummary != null)
        {
            <aside class="info-panel" aria-labelledby="info-panel-title">
                <div class="info-panel-header">
                    <h2 id="info-panel-title" class="panel-title">
                        <i class="bi bi-info-circle" aria-hidden="true"></i>
                        Stadium Information
                    </h2>
                    <button class="btn btn-sm btn-outline-secondary"
                            @onclick="ToggleInfoPanel"
                            aria-expanded="@(!isInfoPanelCollapsed)"
                            aria-controls="info-panel-content">
                        <i class="bi bi-@(isInfoPanelCollapsed ? "chevron-down" : "chevron-up")" aria-hidden="true"></i>
                    </button>
                </div>

                <div id="info-panel-content" class="info-panel-content @(isInfoPanelCollapsed ? "collapsed" : "")">
                    <div class="stadium-stats">
                        <div class="stat">
                            <div class="stat-value">@stadiumSummary.TotalSeats.ToString("N0")</div>
                            <div class="stat-label">Total Seats</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">@stadiumSummary.TotalSectors</div>
                            <div class="stat-label">Sectors</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">@stadiumSummary.TotalTribunes</div>
                            <div class="stat-label">Tribunes</div>
                        </div>
                        @if (selectedEventId > 0 && eventSeatStatus != null)
                        {
                            <div class="stat">
                                <div class="stat-value">@GetOverallOccupancyPercentage()%</div>
                                <div class="stat-label">Occupied</div>
                            </div>
                        }
                    </div>

                    @if (selectedEventId > 0 && selectedEvent != null)
                    {
                        <div class="event-details">
                            <h4>Current Event</h4>
                            <div class="event-info-grid">
                                <div class="info-item">
                                    <span class="label">Event:</span>
                                    <span class="value">@selectedEvent.EventName</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">Date:</span>
                                    <span class="value">@selectedEvent.EventDate.ToString("MMM dd, yyyy HH:mm")</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">Status:</span>
                                    <span class="value">
                                        <span class="badge @(selectedEvent.IsActive ? "badge-success" : "badge-secondary")">
                                            @(selectedEvent.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </aside>
        }
    </main>

    <!-- Legend Panel -->
    @if (showLegend)
    {
        <div class="legend-panel" role="complementary" aria-labelledby="legend-title">
            <div class="legend-header">
                <h3 id="legend-title" class="legend-title">
                    <i class="bi bi-info-circle-fill" aria-hidden="true"></i>
                    Legend
                </h3>
                <button class="btn btn-sm btn-outline-secondary"
                        @onclick="ToggleLegend"
                        aria-label="Close legend">
                    <i class="bi bi-x" aria-hidden="true"></i>
                </button>
            </div>

            <div class="legend-content">
                @if (selectedEventId > 0)
                {
                    <div class="legend-section">
                        <h4>Occupancy Status</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color available" aria-hidden="true"></div>
                                <div class="legend-text">
                                    <span class="legend-label">Available</span>
                                    <span class="legend-description">0-49% occupied</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color partial" aria-hidden="true"></div>
                                <div class="legend-text">
                                    <span class="legend-label">Limited</span>
                                    <span class="legend-description">50-89% occupied</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color full" aria-hidden="true"></div>
                                <div class="legend-text">
                                    <span class="legend-label">Sold Out</span>
                                    <span class="legend-description">90-100% occupied</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="legend-section">
                        <h4>Sector Types</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color standard" aria-hidden="true"></div>
                                <div class="legend-text">
                                    <span class="legend-label">Standard</span>
                                    <span class="legend-description">Regular seating</span>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color vip" aria-hidden="true"></div>
                                <div class="legend-text">
                                    <span class="legend-label">VIP</span>
                                    <span class="legend-description">Premium seating</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- Sector Detail Modal -->
@if (showSectorModal && selectedSector != null)
{
    <div class="modal-backdrop" @onclick="CloseSectorModal">
        <div class="modal-dialog" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title" class="modal-title">@selectedSector.Name</h3>
                    <button type="button" class="btn-close" @onclick="CloseSectorModal" aria-label="Close modal">
                        <i class="bi bi-x" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="sector-details">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Sector ID:</span>
                                <span class="detail-value">@selectedSector.Id</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Total Seats:</span>
                                <span class="detail-value">@selectedSector.TotalSeats</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Available:</span>
                                <span class="detail-value">@GetAvailableSeats(selectedSector)</span>
                            </div>
                            @if (selectedEventId > 0)
                            {
                                <div class="detail-item">
                                    <span class="detail-label">Occupancy:</span>
                                    <span class="detail-value">@GetOccupancyPercentage(selectedSector)%</span>
                                </div>
                            }
                        </div>

                        @if (selectedEventId > 0)
                        {
                            <div class="occupancy-visualization">
                                <h4>Seat Occupancy</h4>
                                <div class="occupancy-chart">
                                    <div class="chart-bar">
                                        <div class="chart-segment available"
                                             style="width: @(100 - GetOccupancyPercentage(selectedSector))%"
                                             title="Available seats"></div>
                                        <div class="chart-segment occupied"
                                             style="width: @GetOccupancyPercentage(selectedSector)%"
                                             title="Occupied seats"></div>
                                    </div>
                                    <div class="chart-labels">
                                        <span class="available-label">@GetAvailableSeats(selectedSector) Available</span>
                                        <span class="occupied-label">@(selectedSector.TotalSeats - GetAvailableSeats(selectedSector)) Occupied</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSectorModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}