@page "/events"
@page "/events/management"
@using StadiumDrinkOrdering.Admin.Services
@using StadiumDrinkOrdering.Shared.Models
@using StadiumDrinkOrdering.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@rendermode @(new InteractiveServerRenderMode())

<PageTitle>Event Management - Stadium Admin</PageTitle>

<div class="event-management-container">
    <!-- Header with Quick Actions -->
    <div class="management-header">
        <div class="header-content">
            <div class="header-left">
                <h1>🎪 Event Management</h1>
                <p>Manage stadium events, ticket sales, and analytics</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" @onclick="ShowCreateEventModal" id="admin-events-create-btn">
                    ➕ Create New Event
                </button>
                <button class="btn btn-primary" @onclick="GenerateDemoData" id="admin-events-demo-data-btn">
                    🎲 Generate Demo Data
                </button>
                <button class="btn btn-secondary" @onclick="RefreshEvents" id="admin-events-refresh-btn">
                    🔄 Refresh
                </button>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-icon">🎫</div>
                <div class="stat-content">
                    <div class="stat-number">@(events?.Count ?? 0)</div>
                    <div class="stat-label">Total Events</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🟢</div>
                <div class="stat-content">
                    <div class="stat-number">@(events?.Count(e => e.IsActive) ?? 0)</div>
                    <div class="stat-label">Active Events</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div class="stat-content">
                    <div class="stat-number">€@totalRevenue.ToString("N0")</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-content">
                    <div class="stat-number">@totalTicketsSold</div>
                    <div class="stat-label">Tickets Sold</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and View Controls -->
    <div class="view-controls">
        <div class="filter-section">
            <div class="filter-group">
                <label>Event Type:</label>
                <select @bind="selectedEventType" @bind:after="FilterEvents" class="filter-select">
                    <option value="">All Types</option>
                    <option value="Football">Football</option>
                    <option value="Concert">Concert</option>
                    <option value="Basketball">Basketball</option>
                    <option value="Boxing">Boxing</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select @bind="selectedStatus" @bind:after="FilterEvents" class="filter-select">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="past">Past</option>
                </select>
            </div>
            <div class="search-group">
                <input @bind="searchQuery" @onkeyup="FilterEvents" placeholder="Search events..." class="search-input" />
                <button class="search-btn" id="admin-events-search-btn">🔍</button>
            </div>
        </div>
        
        <div class="view-toggles">
            <button class="view-btn @(viewMode == "grid" ? "active" : "")" @onclick="SetGridView" id="admin-events-grid-view-btn">
                📋 Grid
            </button>
            <button class="view-btn @(viewMode == "calendar" ? "active" : "")" @onclick="SetCalendarView" id="admin-events-calendar-view-btn">
                📅 Calendar
            </button>
        </div>
    </div>

    <!-- Events Display -->
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <h3>Loading Events...</h3>
        </div>
    }
    else if (viewMode == "grid")
    {
        <div class="events-grid">
            @foreach (var eventItem in filteredEvents)
            {
                <div class="event-card @(eventItem.IsActive ? "active" : "inactive")" @onclick="() => ShowEventDetails(eventItem)">
                    <div class="event-header">
                        <div class="event-type-badge @eventItem.EventType.ToLower()">
                            @GetEventTypeIcon(eventItem.EventType) @eventItem.EventType
                        </div>
                        <div class="event-status">
                            @if (eventItem.IsActive)
                            {
                                <span class="status-active">🟢 Active</span>
                            }
                            else
                            {
                                <span class="status-inactive">🔴 Inactive</span>
                            }
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(eventItem.ImageUrl))
                    {
                        <div class="event-image">
                            <img src="@eventItem.ImageUrl" alt="@eventItem.EventName" />
                        </div>
                    }
                    else
                    {
                        <div class="event-image-placeholder">
                            <div class="placeholder-icon">@GetEventTypeIcon(eventItem.EventType)</div>
                        </div>
                    }
                    
                    <div class="event-content">
                        <h3 class="event-name">@eventItem.EventName</h3>
                        <p class="event-description">@eventItem.Description</p>
                        
                        <div class="event-details">
                            <div class="detail-item">
                                <span class="detail-icon">📅</span>
                                <span class="detail-text">@eventItem.EventDate.ToString("MMM dd, yyyy")</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">⏰</span>
                                <span class="detail-text">@eventItem.EventDate.ToString("h:mm tt")</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">🎫</span>
                                <span class="detail-text">@eventItem.TotalSeats seats</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">🎟️</span>
                                <span class="detail-text">@(eventItem.Tickets?.Count ?? 0) sold</span>
                            </div>
                            @if (eventItem.BaseTicketPrice.HasValue)
                            {
                                <div class="detail-item">
                                    <span class="detail-icon">💰</span>
                                    <span class="detail-text">€@eventItem.BaseTicketPrice.Value.ToString("F2")</span>
                                </div>
                            }
                        </div>
                        
                        @if (eventItem.Analytics != null)
                        {
                            <div class="event-analytics">
                                <div class="analytics-item">
                                    <div class="analytics-number">@eventItem.Analytics.TotalTicketsSold</div>
                                    <div class="analytics-label">Tickets Sold</div>
                                </div>
                                <div class="analytics-item">
                                    <div class="analytics-number">€@eventItem.Analytics.TicketRevenue.ToString("N0")</div>
                                    <div class="analytics-label">Ticket Revenue</div>
                                </div>
                                <div class="analytics-item">
                                    <div class="analytics-number">€@eventItem.Analytics.DrinksRevenue.ToString("N0")</div>
                                    <div class="analytics-label">Drinks Revenue</div>
                                </div>
                                <div class="analytics-item">
                                    <div class="analytics-number">€@eventItem.Analytics.TotalRevenue.ToString("N0")</div>
                                    <div class="analytics-label">Total Revenue</div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <div class="event-actions">
                        <button class="btn btn-primary btn-sm" @onclick:stopPropagation="true" @onclick="() => ShowEventDetails(eventItem)" id="admin-events-view-details-@eventItem.Id-btn">
                            📊 View Details
                        </button>
                        <button class="btn btn-secondary btn-sm" @onclick:stopPropagation="true" @onclick="() => EditEvent(eventItem)" id="admin-events-edit-@eventItem.Id-btn">
                            ✏️ Edit
                        </button>
                        @if (eventItem.IsActive)
                        {
                            <button class="btn btn-warning btn-sm" @onclick:stopPropagation="true" @onclick="() => DeactivateEvent(eventItem)" id="admin-events-deactivate-@eventItem.Id-btn">
                                ⏸️ Deactivate
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success btn-sm" @onclick:stopPropagation="true" @onclick="() => ActivateEvent(eventItem)" id="admin-events-activate-@eventItem.Id-btn">
                                ▶️ Activate
                            </button>
                        }
                    </div>
                </div>
            }
            
            @if (!filteredEvents.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">🎪</div>
                    <h3>No Events Found</h3>
                    <p>@(events?.Any() == true ? "Try adjusting your filters" : "Create your first event to get started")</p>
                    @if (events?.Any() != true)
                    {
                        <button class="btn btn-primary" @onclick="ShowCreateEventModal" id="admin-events-create-first-btn">
                            Create First Event
                        </button>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <!-- Calendar View -->
        <div class="calendar-container">
            <div class="calendar-header">
                <button class="calendar-nav" @onclick="PreviousMonth" id="admin-events-prev-month-btn">‹</button>
                <h2>@currentCalendarDate.ToString("MMMM yyyy")</h2>
                <button class="calendar-nav" @onclick="NextMonth" id="admin-events-next-month-btn">›</button>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-days-header">
                    <div class="day-header">Sun</div>
                    <div class="day-header">Mon</div>
                    <div class="day-header">Tue</div>
                    <div class="day-header">Wed</div>
                    <div class="day-header">Thu</div>
                    <div class="day-header">Fri</div>
                    <div class="day-header">Sat</div>
                </div>
                
                <div class="calendar-days">
                    @foreach (var day in GetCalendarDays())
                    {
                        <div class="calendar-day @(day.IsCurrentMonth ? "current-month" : "other-month") @(day.IsToday ? "today" : "")">
                            <div class="day-number">@day.Date.Day</div>
                            @foreach (var eventItem in day.Events)
                            {
                                <div class="calendar-event @eventItem.EventType.ToLower()" @onclick="() => ShowEventDetails(eventItem)">
                                    <div class="event-time">@eventItem.EventDate.ToString("HH:mm")</div>
                                    <div class="event-title">@eventItem.EventName</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- Create/Edit Event Modal -->
@if (showEventModal)
{
    <div class="modal-overlay" @onclick="CloseEventModal">
        <div class="event-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(editingEvent == null ? "Create New Event" : "Edit Event")</h3>
                <button class="btn-close" @onclick="CloseEventModal" id="admin-events-modal-close-btn">✕</button>
            </div>
            
            <div class="modal-content">
                <form @onsubmit="SaveEvent" @onsubmit:preventDefault="true">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Event Name *</label>
                            <input @bind="eventForm.EventName" class="form-control" required maxlength="200" />
                        </div>
                        
                        <div class="form-group">
                            <label>Event Type *</label>
                            <select @bind="eventForm.EventType" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="Football">Football</option>
                                <option value="Concert">Concert</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Baseball">Baseball</option>
                                <option value="Hockey">Hockey</option>
                                <option value="Boxing">Boxing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Event Date *</label>
                            <input @bind="eventForm.EventDate" type="datetime-local" class="form-control" required />
                        </div>
                        
                        <div class="form-group">
                            <label>Total Seats *</label>
                            <input @bind="eventForm.TotalSeats" type="number" class="form-control" min="1" max="100000" required />
                        </div>
                        
                        <div class="form-group">
                            <label>Base Ticket Price</label>
                            <input @bind="eventForm.BaseTicketPrice" type="number" step="0.01" min="0" class="form-control" />
                        </div>
                        
                        <div class="form-group">
                            <label>Image URL</label>
                            <input @bind="eventForm.ImageUrl" class="form-control" maxlength="500" />
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea @bind="eventForm.Description" class="form-control" rows="3" maxlength="1000"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" @onclick="CloseEventModal" id="admin-events-modal-cancel-btn">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving" id="admin-events-modal-save-btn">
                            @if (isSaving)
                            {
                                <span>💾 Saving...</span>
                            }
                            else
                            {
                                <span>@(editingEvent == null ? "Create Event" : "Update Event")</span>
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Event Details Modal -->
@if (selectedEvent != null && showDetailsModal)
{
    <div class="modal-overlay" @onclick="CloseDetailsModal">
        <div class="details-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div class="header-info">
                    <h3>@selectedEvent.EventName</h3>
                    <div class="event-meta">
                        <span class="event-type-badge @selectedEvent.EventType.ToLower()">
                            @GetEventTypeIcon(selectedEvent.EventType) @selectedEvent.EventType
                        </span>
                        <span class="event-date">
                            📅 @selectedEvent.EventDate.ToString("MMM dd, yyyy • h:mm tt")
                        </span>
                    </div>
                </div>
                <button class="btn-close" @onclick="CloseDetailsModal" id="admin-events-details-close-btn">✕</button>
            </div>
            
            <div class="modal-content">
                <div class="details-grid">
                    <!-- Event Information -->
                    <div class="details-section">
                        <h4>Event Information</h4>
                        <div class="info-card">
                            @if (!string.IsNullOrEmpty(selectedEvent.ImageUrl))
                            {
                                <img src="@selectedEvent.ImageUrl" alt="@selectedEvent.EventName" class="event-detail-image" />
                            }
                            <div class="info-content">
                                <p><strong>Description:</strong> @(selectedEvent.Description ?? "No description provided")</p>
                                <p><strong>Total Seats:</strong> @selectedEvent.TotalSeats.ToString("N0")</p>
                                @if (selectedEvent.BaseTicketPrice.HasValue)
                                {
                                    <p><strong>Base Price:</strong> €@selectedEvent.BaseTicketPrice.Value.ToString("F2")</p>
                                }
                                <p><strong>Status:</strong> @(selectedEvent.IsActive ? "🟢 Active" : "🔴 Inactive")</p>
                                <p><strong>Created:</strong> @selectedEvent.CreatedAt.ToString("MMM dd, yyyy • h:mm tt")</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics -->
                    @if (selectedEvent.Analytics != null)
                    {
                        <div class="details-section">
                            <h4>Analytics</h4>
                            <div class="analytics-grid">
                                <div class="analytics-card">
                                    <div class="analytics-icon">🎫</div>
                                    <div class="analytics-content">
                                        <div class="analytics-number">@selectedEvent.Analytics.TotalTicketsSold</div>
                                        <div class="analytics-label">Tickets Sold</div>
                                        <div class="analytics-percent">
                                            @(selectedEvent.TotalSeats > 0 ? $"{(selectedEvent.Analytics.TotalTicketsSold * 100.0 / selectedEvent.TotalSeats):F1}%" : "0%")
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="analytics-card">
                                    <div class="analytics-icon">🛒</div>
                                    <div class="analytics-content">
                                        <div class="analytics-number">@selectedEvent.Analytics.TotalOrders</div>
                                        <div class="analytics-label">Total Orders</div>
                                        <div class="analytics-percent">
                                            @(selectedEvent.Analytics.TotalTicketsSold > 0 ? $"{(selectedEvent.Analytics.TotalOrders * 100.0 / selectedEvent.Analytics.TotalTicketsSold):F1}%" : "0%") order rate
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="analytics-card">
                                    <div class="analytics-icon">💰</div>
                                    <div class="analytics-content">
                                        <div class="analytics-number">€@selectedEvent.Analytics.TotalRevenue.ToString("N0")</div>
                                        <div class="analytics-label">Total Revenue</div>
                                        <div class="analytics-percent">
                                            €@selectedEvent.Analytics.AverageOrderValue.ToString("F2") avg order
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="analytics-card">
                                    <div class="analytics-icon">🍻</div>
                                    <div class="analytics-content">
                                        <div class="analytics-number">@selectedEvent.Analytics.TotalDrinksSold</div>
                                        <div class="analytics-label">Drinks Sold</div>
                                        @if (!string.IsNullOrEmpty(selectedEvent.Analytics.MostPopularDrink))
                                        {
                                            <div class="analytics-percent">
                                                🔥 @selectedEvent.Analytics.MostPopularDrink
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            @if (selectedEvent.Analytics.PeakOrderTime.HasValue)
                            {
                                <div class="peak-time-info">
                                    <strong>Peak Order Time:</strong> @selectedEvent.Analytics.PeakOrderTime.Value.ToString("h:mm tt")
                                </div>
                            }
                        </div>
                    }
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-primary" @onclick="() => EditEvent(selectedEvent)" id="admin-events-details-edit-btn">
                        ✏️ Edit Event
                    </button>
                    <button class="btn btn-success" @onclick="() => ViewEventOrders(selectedEvent)" id="admin-events-details-orders-btn">
                        📋 View Orders
                    </button>
                    <button class="btn btn-info" @onclick="() => ViewEventTickets(selectedEvent)" id="admin-events-details-tickets-btn">
                        🎫 View Tickets
                    </button>
                    @if (selectedEvent.IsActive)
                    {
                        <button class="btn btn-warning" @onclick="() => DeactivateEvent(selectedEvent)" id="admin-events-details-deactivate-btn">
                            ⏸️ Deactivate
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="() => ActivateEvent(selectedEvent)" id="admin-events-details-activate-btn">
                            ▶️ Activate
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (showToast)
{
    <div class="toast @toastType">
        <div class="toast-content">
            <span>@toastMessage</span>
            <button class="toast-close" @onclick="HideToast" id="admin-events-toast-close-btn">×</button>
        </div>
    </div>
}

